'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Button } from '@/components/ui/button'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Badge } from '@/components/ui/badge'
import { Calculator, DollarSign, Percent, HelpCircle, Building } from 'lucide-react'
import type { PropertyAssumptions } from '@/lib/financial-modeling/proforma'

interface FinancingCardProps {
  assumptions: PropertyAssumptions
  onAssumptionsChange: (assumptions: PropertyAssumptions) => void
}

export function FinancingCard({ assumptions, onAssumptionsChange }: FinancingCardProps) {
  
  const updateAssumption = <K extends keyof PropertyAssumptions>(
    key: K,
    value: PropertyAssumptions[K]
  ) => {
    onAssumptionsChange({ ...assumptions, [key]: value })
  }

  // Calculate loan amount based on financing type
  const calculateLoanAmount = () => {
    if (assumptions.financingType === 'ltv' && assumptions.targetLTV && assumptions.purchasePrice) {
      return (assumptions.targetLTV / 100) * assumptions.purchasePrice
    } else if (assumptions.financingType === 'dscr' && assumptions.targetDSCR) {
      // Calculate based on NOI and DSCR
      let year1NOI = 0
      if (assumptions.potentialRentalIncome?.[0] && assumptions.potentialRentalIncome[0] > 0) {
        // Use detailed income structure
        const grossIncome = assumptions.potentialRentalIncome[0]
        const vacancyAmount = grossIncome * (assumptions.vacancyRates?.[0] || 0)
        const effectiveGrossIncome = grossIncome - vacancyAmount
        
        let opEx = 0
        if (assumptions.operatingExpenses?.[0] !== undefined) {
          if (assumptions.operatingExpenseType === 'percentage') {
            opEx = effectiveGrossIncome * ((assumptions.operatingExpenses[0] || 0) / 100)
          } else {
            opEx = assumptions.operatingExpenses[0] || 0
          }
        }
        
        year1NOI = effectiveGrossIncome - opEx
      } else if (assumptions.year1NOI) {
        year1NOI = assumptions.year1NOI
      }
      
      if (year1NOI > 0 && assumptions.interestRate > 0 && assumptions.amortizationYears > 0) {
        const maxAnnualDebtService = year1NOI / assumptions.targetDSCR
        // Calculate loan amount that produces this debt service
        const paymentsPerYear = assumptions.paymentsPerYear || 12
        const periodicRate = assumptions.interestRate / paymentsPerYear
        const totalPayments = assumptions.amortizationYears * paymentsPerYear
        
        if (periodicRate > 0) {
          const numerator = (maxAnnualDebtService * paymentsPerYear) * (Math.pow(1 + periodicRate, totalPayments) - 1)
          const denominator = periodicRate * Math.pow(1 + periodicRate, totalPayments)
          return numerator / denominator
        }
      }
    }
    return assumptions.loanAmount
  }

  // Auto-calculate loan amount when parameters change
  const handleAutoCalculation = () => {
    if (assumptions.financingType === 'cash') {
      updateAssumption('loanAmount', 0)
    } else {
      const calculatedLoanAmount = calculateLoanAmount()
      updateAssumption('loanAmount', Math.round(calculatedLoanAmount * 100) / 100)
    }
  }

  const formatCurrency = (value: number) => {
    return value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
  }


  // Calculate current metrics for display
  const currentLTV = assumptions.purchasePrice > 0 ? (assumptions.loanAmount / assumptions.purchasePrice) * 100 : 0
  const year1NOI = (() => {
    if (assumptions.potentialRentalIncome?.[0] && assumptions.potentialRentalIncome[0] > 0) {
      const grossIncome = assumptions.potentialRentalIncome[0]
      const vacancyAmount = grossIncome * (assumptions.vacancyRates?.[0] || 0)
      const effectiveGrossIncome = grossIncome - vacancyAmount
      
      let opEx = 0
      if (assumptions.operatingExpenses?.[0] !== undefined) {
        if (assumptions.operatingExpenseType === 'percentage') {
          opEx = effectiveGrossIncome * ((assumptions.operatingExpenses[0] || 0) / 100)
        } else {
          opEx = assumptions.operatingExpenses[0] || 0
        }
      }
      
      return effectiveGrossIncome - opEx
    } else if (assumptions.year1NOI) {
      return assumptions.year1NOI
    }
    return 0
  })()

  // Calculate annual debt service for DSCR calculation
  const calculateAnnualDebtService = () => {
    if (assumptions.loanAmount <= 0 || assumptions.interestRate <= 0) return 0
    
    const paymentsPerYear = assumptions.paymentsPerYear || 12
    const periodicRate = assumptions.interestRate / paymentsPerYear
    const totalPayments = assumptions.amortizationYears * paymentsPerYear
    
    if (periodicRate === 0) {
      return assumptions.loanAmount / assumptions.amortizationYears
    }
    
    const numerator = assumptions.loanAmount * periodicRate * Math.pow(1 + periodicRate, totalPayments)
    const denominator = Math.pow(1 + periodicRate, totalPayments) - 1
    const periodicPayment = numerator / denominator
    
    return periodicPayment * paymentsPerYear
  }

  const annualDebtService = calculateAnnualDebtService()
  const currentDSCR = annualDebtService > 0 ? year1NOI / annualDebtService : 0

  return (
    <div className="space-y-6">
      <div className="pb-2 border-b">
        <h3 className="text-lg font-medium mb-1 flex items-center gap-2">
          <Building className="h-5 w-5" />
          Financing Assumptions
        </h3>
        <p className="text-sm text-muted-foreground">
          Choose your financing approach and configure loan parameters
        </p>
      </div>
      
      {/* Financing Type Selection */}
      <div className="space-y-4">
        <Label className="text-base font-medium">Financing Method</Label>
        <Tabs 
          value={assumptions.financingType} 
          onValueChange={(value: string) => {
            const typedValue = value as 'dscr' | 'ltv' | 'cash'
            updateAssumption('financingType', typedValue)
            // Auto-calculate loan amount for new type
            setTimeout(() => {
              if (typedValue === 'cash') {
                updateAssumption('loanAmount', 0)
              } else {
                handleAutoCalculation()
              }
            }, 100)
          }}
          className="w-full"
        >
            <TabsList className="grid w-full grid-cols-3">
              <TabsTrigger value="dscr" className="flex items-center gap-2">
                <Calculator className="w-4 h-4" />
                DSCR
              </TabsTrigger>
              <TabsTrigger value="ltv" className="flex items-center gap-2">
                <Percent className="w-4 h-4" />
                LTV
              </TabsTrigger>
              <TabsTrigger value="cash" className="flex items-center gap-2">
                <DollarSign className="w-4 h-4" />
                All Cash
              </TabsTrigger>
            </TabsList>
            
            {/* DSCR Content */}
            <TabsContent value="dscr" className="space-y-4 mt-6">
              <Alert>
                <AlertDescription className="flex items-start gap-2">
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <HelpCircle className="w-4 h-4 mt-0.5 flex-shrink-0 cursor-help" />
                      </TooltipTrigger>
                      <TooltipContent side="right" className="max-w-xs">
                        <p className="text-sm">
                          <strong>Debt Service Coverage Ratio (DSCR):</strong> Measures the property&apos;s ability to cover debt payments. 
                          Calculated as Net Operating Income ÷ Annual Debt Service. 
                          Lenders typically require DSCR of 1.20x or higher, meaning the property generates 20% more income than needed for debt payments.
                        </p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                  <div>
                    <strong>DSCR-Based Financing:</strong> Loan amount calculated based on the property&apos;s income and your target debt coverage ratio.
                    Higher DSCR = lower risk but smaller loan amount.
                  </div>
                </AlertDescription>
              </Alert>
              
              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label htmlFor="target-dscr">Target DSCR</Label>
                  <Input
                    id="target-dscr"
                    type="number"
                    step="0.05"
                    min="1.0"
                    max="3.0"
                    value={assumptions.targetDSCR || ''}
                    onChange={(e) => updateAssumption('targetDSCR', parseFloat(e.target.value) || undefined)}
                    placeholder="1.25"
                  />
                  <p className="text-xs text-muted-foreground">Typical range: 1.20x - 1.50x</p>
                </div>
                
                <div className="space-y-2">
                  <Label>Calculated Loan Amount</Label>
                  <div className="h-10 px-3 py-2 bg-muted/30 rounded-md flex items-center">
                    <span className="font-medium">
                      ${formatCurrency(calculateLoanAmount())}
                    </span>
                  </div>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    onClick={handleAutoCalculation}
                    disabled={!assumptions.targetDSCR}
                  >
                    Update Loan Amount
                  </Button>
                </div>
              </div>
            </TabsContent>
            
            {/* LTV Content */}
            <TabsContent value="ltv" className="space-y-4 mt-6">
              <Alert>
                <AlertDescription className="flex items-start gap-2">
                  <TooltipProvider>
                    <Tooltip>
                      <TooltipTrigger asChild>
                        <HelpCircle className="w-4 h-4 mt-0.5 flex-shrink-0 cursor-help" />
                      </TooltipTrigger>
                      <TooltipContent side="right" className="max-w-xs">
                        <p className="text-sm">
                          <strong>Loan-to-Value Ratio (LTV):</strong> The loan amount as a percentage of the property&apos;s purchase price. 
                          Calculated as Loan Amount ÷ Purchase Price × 100. 
                          Lower LTV = more equity required but typically better loan terms. Commercial properties often max at 70-80% LTV.
                        </p>
                      </TooltipContent>
                    </Tooltip>
                  </TooltipProvider>
                  <div>
                    <strong>LTV-Based Financing:</strong> Loan amount calculated as a percentage of the property&apos;s purchase price.
                    Higher LTV = less cash down but higher monthly payments.
                  </div>
                </AlertDescription>
              </Alert>
              
              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label htmlFor="target-ltv">Target LTV (%)</Label>
                  <Input
                    id="target-ltv"
                    type="number"
                    step="5"
                    min="0"
                    max="90"
                    value={assumptions.targetLTV || ''}
                    onChange={(e) => updateAssumption('targetLTV', parseFloat(e.target.value) || undefined)}
                    placeholder="75"
                  />
                  <p className="text-xs text-muted-foreground">Typical range: 70% - 80%</p>
                </div>
                
                <div className="space-y-2">
                  <Label>Calculated Loan Amount</Label>
                  <div className="h-10 px-3 py-2 bg-muted/30 rounded-md flex items-center">
                    <span className="font-medium">
                      ${formatCurrency(calculateLoanAmount())}
                    </span>
                  </div>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    onClick={handleAutoCalculation}
                    disabled={!assumptions.targetLTV}
                  >
                    Update Loan Amount
                  </Button>
                </div>
              </div>
            </TabsContent>
            
            {/* Cash Content */}
            <TabsContent value="cash" className="space-y-4 mt-6">
              <Alert>
                <AlertDescription>
                  <strong>All Cash Purchase:</strong> No financing - you&apos;ll purchase the property outright with cash.
                  This eliminates debt service and interest expenses but requires more capital upfront.
                </AlertDescription>
              </Alert>
              
              <div className="text-center p-6 bg-muted/30 rounded-lg">
                <DollarSign className="w-12 h-12 mx-auto mb-3 text-primary" />
                <h3 className="text-lg font-medium mb-2">Cash Purchase</h3>
                <p className="text-muted-foreground mb-4">No loan required - financing fields will be disabled</p>
                <Badge variant="secondary" className="text-sm">
                  Loan Amount: $0
                </Badge>
              </div>
            </TabsContent>
          </Tabs>
        </div>

        {/* Loan Details - Only show if not cash */}
        {assumptions.financingType !== 'cash' && (
          <div className="space-y-6 pt-4 border-t">
            <h4 className="text-base font-medium text-muted-foreground">Loan Parameters</h4>
            
            {/* Manual loan amount override */}
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <Label htmlFor="loan-amount">Loan Amount</Label>
                <Badge variant="outline" className="text-xs">
                  Can override calculated amount
                </Badge>
              </div>
              <Input
                id="loan-amount"
                type="number"
                value={assumptions.loanAmount ? assumptions.loanAmount.toFixed(2) : ''}
                onChange={(e) => updateAssumption('loanAmount', parseFloat(e.target.value) || 0)}
                placeholder="0"
              />
            </div>

            {/* Loan Terms */}
            <div className="grid gap-4 md:grid-cols-2">
              <div className="space-y-2">
                <Label htmlFor="interest-rate">Interest Rate (%)</Label>
                <Input
                  id="interest-rate"
                  type="number"
                  step="0.125"
                  min="0"
                  max="15"
                  value={assumptions.interestRate ? (assumptions.interestRate * 100).toFixed(3) : ''}
                  onChange={(e) => updateAssumption('interestRate', (parseFloat(e.target.value) || 0) / 100)}
                  placeholder="6.500"
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="loan-term">Loan Term (Years)</Label>
                <Input
                  id="loan-term"
                  type="number"
                  min="1"
                  max="30"
                  value={assumptions.loanTermYears || ''}
                  onChange={(e) => updateAssumption('loanTermYears', parseFloat(e.target.value) || 0)}
                  placeholder="10"
                />
              </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2">
              <div className="space-y-2">
                <Label htmlFor="amortization">Amortization (Years)</Label>
                <Input
                  id="amortization"
                  type="number"
                  min="1"
                  max="50"
                  value={assumptions.amortizationYears || ''}
                  onChange={(e) => updateAssumption('amortizationYears', parseFloat(e.target.value) || 0)}
                  placeholder="30"
                />
              </div>
              
              <div className="space-y-2">
                <Label htmlFor="payment-frequency">Payment Frequency</Label>
                <Select
                  value={assumptions.paymentsPerYear.toString()}
                  onValueChange={(value) => updateAssumption('paymentsPerYear', parseInt(value))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="12">Monthly (12/year)</SelectItem>
                    <SelectItem value="4">Quarterly (4/year)</SelectItem>
                    <SelectItem value="2">Semi-Annual (2/year)</SelectItem>
                    <SelectItem value="1">Annual (1/year)</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Loan Costs */}
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <Label htmlFor="loan-costs">Loan Costs (% of Loan Amount)</Label>
                <TooltipProvider>
                  <Tooltip>
                    <TooltipTrigger asChild>
                      <HelpCircle className="w-3.5 h-3.5 text-muted-foreground cursor-help" />
                    </TooltipTrigger>
                    <TooltipContent>
                      <p className="max-w-xs text-sm">
                        Loan origination fees, points, appraisal, legal, and other loan-related costs as a percentage of the loan amount. Typical range: 1% - 3%.
                      </p>
                    </TooltipContent>
                  </Tooltip>
                </TooltipProvider>
              </div>
              <Input
                id="loan-costs"
                type="number"
                step="0.25"
                min="0"
                max="10"
                value={assumptions.loanCosts || ''}
                onChange={(e) => updateAssumption('loanCosts', parseFloat(e.target.value) || 0)}
                placeholder="2.0"
              />
              {assumptions.loanCosts > 0 && assumptions.loanAmount > 0 && (
                <p className="text-xs text-muted-foreground">
                  Loan costs: ${formatCurrency((assumptions.loanCosts / 100) * assumptions.loanAmount)}
                </p>
              )}
            </div>
          </div>
        )}

        {/* Current Metrics Summary */}
        {assumptions.financingType !== 'cash' && assumptions.loanAmount > 0 && (
          <div className="pt-4 border-t">
            <h4 className="text-base font-medium text-muted-foreground mb-4">Current Financing Metrics</h4>
            <div className="grid gap-4 md:grid-cols-3">
              <div className="text-center p-3 bg-muted/30 rounded-lg">
                <div className="text-xs text-muted-foreground">Loan-to-Value</div>
                <div className="text-lg font-semibold">{currentLTV.toFixed(1)}%</div>
              </div>
              <div className="text-center p-3 bg-muted/30 rounded-lg">
                <div className="text-xs text-muted-foreground">Debt Service Coverage</div>
                <div className="text-lg font-semibold">
                  {currentDSCR > 0 ? `${currentDSCR.toFixed(2)}x` : '—'}
                </div>
              </div>
              <div className="text-center p-3 bg-muted/30 rounded-lg">
                <div className="text-xs text-muted-foreground">Annual Debt Service</div>
                <div className="text-lg font-semibold">
                  ${formatCurrency(annualDebtService)}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}